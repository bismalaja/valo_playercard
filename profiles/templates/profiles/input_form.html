{% extends "profiles/base.html" %}
{% load static %}

{% block title %}SQUAD ENTRY - Upload Data{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'profiles/css/input_form.css' %}">
{% endblock %}

{% block content %}
<div class="menu-container">
    <div class="menu-btn" onclick="this.nextElementSibling.classList.toggle('active')">â‰¡</div>
    <div class="menu-dropdown">
        <a href="{% url 'profile_list' %}" class="menu-item">Roster</a>
        {% if profile_form.instance.pk %}
        <a href="{% url 'display_profile' profile_form.instance.pk %}" class="menu-item">View Profile</a>
        <a href="{% url 'card_profile' profile_form.instance.pk %}" class="menu-item">Player Card</a>
        {% endif %}
        <a href="{% url 'profile_list' %}" class="menu-item">Cancel</a>
    </div>
</div>

<div class="header">
    <h1>{% if profile_form.instance.pk %}UPDATE PROFILE{% else %}NEW AGENT ENTRY{% endif %}</h1>
    <p>Enter required clearance data</p>
</div>

<form method="post" enctype="multipart/form-data" class="valorant-form">
    {% csrf_token %}

    <div class="form-section">
        <div class="section-title">Identity</div>

        <div class="form-group">
            <label class="form-label">In-Game Name <span style="color:#ff4655">*</span></label>
            {{ profile_form.in_game_name }}
            {% if profile_form.in_game_name.errors %}
            <div class="error-message">{{ profile_form.in_game_name.errors.0 }}</div>
            {% endif %}
        </div>

        <div class="form-group" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <div>
                <label class="form-label">Riot ID <span style="color:#ff4655">*</span></label>
                {{ profile_form.riot_id }}
                {% if profile_form.riot_id.errors %}
                <div class="error-message">{{ profile_form.riot_id.errors.0 }}</div>
                {% endif %}
            </div>
            <div>
                <label class="form-label">Riot Tag (#)</label>
                {{ profile_form.riot_tag }}
                {% if profile_form.riot_tag.errors %}
                <div class="error-message">{{ profile_form.riot_tag.errors.0 }}</div>
                {% endif %}
            </div>
        </div>

        <div class="form-group">
            <label class="form-label">Profile Picture (Upload)</label>
            {{ profile_form.profile_picture }}
            <span class="help-text">Max size 2MB.</span>
            {% if profile_form.profile_picture.errors %}
            <div class="error-message">{{ profile_form.profile_picture.errors.0 }}</div>
            {% endif %}
        </div>

        <div class="form-group">
            <label class="form-label">Or Profile Picture URL</label>
            {{ profile_form.profile_picture_url }}
            <span class="help-text">Paste a direct link to an image (ends in .jpg, .png, etc.)</span>
            {% if profile_form.profile_picture_url.errors %}
            <div class="error-message">{{ profile_form.profile_picture_url.errors.0 }}</div>
            {% endif %}
        </div>
    </div>

    <div class="form-section">
        <div class="section-title">Team Affiliation</div>
        <div class="selection-grid">
            <label class="selection-item">
                <input type="radio" name="team" value="" {% if not profile_form.instance.team %}checked{% endif %}>
                <div class="selection-card">
                    <span class="item-name" style="font-size:1.2rem;">FREE AGENT</span>
                </div>
            </label>

            {% for team in available_teams %}
            <label class="selection-item">
                <input type="radio" name="team" value="{{ team.id }}" {% if profile_form.instance.team.id == team.id %}checked{% endif %}>
                <div class="selection-card">
                    {% if team.get_icon_url %}
                    <img src="{{ team.get_icon_url }}" class="item-icon" alt="{{ team.name }}">
                    {% endif %}
                    <span class="item-name">{{ team.name }}</span>
                </div>
            </label>
            {% endfor %}
        </div>
    </div>

    <div class="form-section">
        <div class="section-title">Preferred Roles</div>
        <div class="selection-grid">
            {% for role in available_roles %}
            <label class="selection-item">
                <input type="checkbox" name="role_id" value="{{ role.id }}" {% if role.id in selected_role_ids %}checked{% endif %}>
                <div class="selection-card">
                    {% if role.get_icon_url %}
                    <img src="{{ role.get_icon_url }}" class="item-icon" alt="{{ role.name }}">
                    {% endif %}
                    <span class="item-name">{{ role.name }}</span>
                </div>
            </label>
            {% endfor %}
        </div>
    </div>

    <div class="form-section">
        <div class="section-title">Active Agents <span style="color:#ff4655">*</span></div>
        {% if custom_errors.agents %}
        <div class="error-message" style="margin-bottom:10px;">{{ custom_errors.agents }}</div>
        {% endif %}
        <div class="selection-grid" style="grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));">
            {% for agent in available_agents %}
            <label class="selection-item">
                <input type="checkbox" name="agent_id" value="{{ agent.id }}" {% if agent.id in selected_agent_ids %}checked{% endif %}>
                <div class="selection-card">
                    <img src="{{ agent.get_icon_url }}" class="item-icon" alt="{{ agent.name }}">
                    <span class="item-name">{{ agent.name }}</span>
                </div>
            </label>
            {% endfor %}
        </div>
    </div>

    <div class="form-section">
        <div class="section-title">Map Preferences (Max 3) <span style="color:#ff4655">*</span></div>
        {% if custom_errors.maps %}
        <div class="error-message" style="margin-bottom:10px;">{{ custom_errors.maps }}</div>
        {% endif %}
        <div class="selection-grid" style="grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));">
            {% for map in available_maps %}
            <label class="selection-item">
                <input type="checkbox" name="map_id" value="{{ map.id }}" class="map-checkbox" {% if map.id in selected_map_ids %}checked{% endif %}>
                <div class="selection-card">
                    {% if map.get_icon_url %}
                    <img src="{{ map.get_icon_url }}" class="item-icon"
                        style="width:100%; height:80px; object-fit:cover; margin-bottom:5px;" alt="{{ map.name }}">
                    {% endif %}
                    <span class="item-name">{{ map.name }}</span>
                </div>
            </label>
            {% endfor %}
        </div>
    </div>

    <div class="form-actions">
        <a href="{% url 'profile_list' %}" class="btn btn-secondary">CANCEL</a>
        <button type="submit" class="btn btn-primary">SAVE DATA</button>
    </div>
</form>
{% endblock %}

{% block extra_js %}
<script>
    document.querySelectorAll('input[type="text"], input[type="number"], textarea, select').forEach(el => {
        el.classList.add('form-control');
    });

    const mapCheckboxes = document.querySelectorAll('.map-checkbox');
    const MAX_MAPS = 3;

    mapCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', () => {
            const checkedCount = document.querySelectorAll('.map-checkbox:checked').length;
            if (checkedCount > MAX_MAPS) {
                checkbox.checked = false;
                alert('You can only select up to ' + MAX_MAPS + ' maps.');
            }
        });
    });

    anime({
        targets: '.valorant-form',
        translateY: [50, 0],
        opacity: [0, 1],
        duration: 800,
        easing: 'easeOutExpo'
    });
</script>
{% endblock %}