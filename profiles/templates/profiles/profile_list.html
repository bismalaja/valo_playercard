{% extends 'profiles/base.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'profiles/css/profile_list.css' %}">
{% endblock %}

{% block content %}

<canvas id="gradient"></canvas>
<div class="container">
    <div class="header">
        <div>
            <a href="/" style="text-decoration: none;">
                <span class="page-subtitle">Tyloo Roster Management</span>
                <h1 class="page-title">VALORANT PROFILES</h1>
            </a>
        </div>
        <div class="auth-links">
            {% if user.is_authenticated %}
            {% if not user.profile_id %}
            <a href="{% url 'input_profile' %}" class="valorant-btn">CREATE PROFILE</a>
            {% else %}
            <a href="{% url 'display_profile' user.profile_id %}" class="valorant-btn secondary">My Profile</a>
            {% endif %}
            {% else %}
            <a href="/accounts/login/" class="valorant-btn secondary"
                style="padding: 8px 15px; font-size: 0.9rem; margin-right: 10px;">Log In</a>
            <a href="/signup/" class="valorant-btn" style="padding: 8px 15px; font-size: 0.9rem;">Sign Up</a>
            {% endif %}
        </div>
    </div>
    <div class="profiles-grid">
        {% for profile in profiles %}
        <div class="profile-card" onclick="window.location.href='{% url 'display_profile' profile.id %}'">
            <span class="corner-decor top-left"></span>
            <span class="corner-decor bottom-right"></span>
            <div class="menu-container" onclick="event.stopPropagation()">
                <button class="menu-btn" onclick="this.nextElementSibling.classList.toggle('active')">â‹®</button>
                <div class="menu-dropdown">
                    <a href="{% url 'card_profile' profile.id %}" class="menu-item">View Card</a>
                    {% if user.is_authenticated and profile.user_id == user.id %}
                    <a href="{% url 'edit_profile' profile.id %}" class="menu-item">Edit</a>
                    <button
                        onclick="confirmDelete('{% url 'delete_profile' profile.id %}', '{{ profile.in_game_name|escapejs }}')"
                        class="menu-item delete">Delete</button>
                    {% endif %}
                    {% if user.is_authenticated and not user.profile_id and not profile.user_id %}
                    <a href="{% url 'claim_profile' profile.id %}" class="menu-item">Claim</a>
                    {% endif %}
                </div>
            </div>
            {% if profile.user_id %}
            <div class="stat-badge"
                style="position:absolute; top:10px; left:10px; background: rgba(0,245,255,0.15); border-color:#00f5ff; color:#00f5ff;">
                Claimed</div>
            {% else %}
            <div class="stat-badge"
                style="position:absolute; top:10px; left:10px; background: rgba(255,70,85,0.15); border-color:#ff4655; color:#ff4655;">
                Unclaimed</div>
            {% endif %}
            {% if profile.profile_picture %}
            <img src="{{ profile.profile_picture.url }}" alt="{{ profile.in_game_name }}" class="card-pfp">
            {% else %}
            <div class="card-pfp"
                style="display:flex; align-items:center; justify-content:center; background:#1f2833; font-size:40px;">
                ?</div>
            {% endif %}
            <h2 class="card-name">{{ profile.in_game_name }}</h2>
            <div class="card-team">#{{ profile.team_name }}</div>
            <div class="card-stats">
                <div class="stat-badge">{{ profile.agents.count }} AGENTS</div>
                <div class="stat-badge">{{ profile.maps.count }} MAPS</div>
            </div>
        </div>
        {% endfor %}
    </div>
    <!-- Hidden form for deletion -->
    <form id="delete-form" method="post" action="">
        <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
    </form>
</div>
<script>
    var granimInstance = new Granim({
        element: '#gradient',
        direction: 'diagonal',
        isPausedWhenNotInView: true,
        states: {
            "default-state": {
                gradients: [
                    ['#0f1923', '#1a2a3a'],
                    ['#1a2a3a', '#0f1923'],
                    ['#0f1923', '#2a1a2a']
                ],
                transitionSpeed: 7000
            }
        }
    });
</script>
<script src="{% static 'profiles/js/notifications.js' %}"></script>
<script>
    function confirmDelete(url, name) {
        if (confirm("Are you sure you want to terminate agent " + name + "? This action cannot be undone.")) {
            var form = document.getElementById('delete-form');
            form.action = url;
            form.submit();
        }
    }
    anime({
        targets: '.profile-card',
        translateY: [20, 0],
        opacity: [0, 1],
        delay: anime.stagger(100),
        easing: 'easeOutExpo'
    });
</script>
{% endblock %}